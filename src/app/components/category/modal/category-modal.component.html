<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()">
  <default-modal [title]="'Categorias'" (close)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="categories-list" *ngIf="!isCreatingNew">
        <div class="list-header">
          <button *ngIf="categories.length > 0" type="button" class="btn-add" (click)="toggleCreateNew(); $event.stopPropagation()" title="Adicionar nova categoria">
             <span>Adicionar</span>
          </button>
        </div>

        <div class="categories-grid">
          <div
            *ngFor="let category of categories"
            class="category-card"
            (click)="selectCategory(category)"
          >
            <div class="category-info">
              <div class="category-color-dot" [ngStyle]="{ 'background-color': category.color }"></div>
              <div class="category-name">{{ category.title }}</div>              
            </div>
            <div class="category-actions">
              <button
                type="button"
                class="btn-edit"
                (click)="editCategory(category); $event.stopPropagation()"
                title="Editar categoria"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                type="button"
                class="btn-delete"
                (click)="deleteCategory(category.id); $event.stopPropagation()"
                title="Deletar categoria"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="categories.length === 0">
          <p>Nenhuma categoria criada ainda</p>
          <button type="button" class="btn-primary" (click)="toggleCreateNew(); $event.stopPropagation()">Criar Primeira Categoria</button>
        </div>
      </div>

      <div class="create-form" *ngIf="isCreatingNew">
        <div class="form-header">
          <app-title size="h3" [title]="editingCategory ? 'Editar Categoria' : 'Nova Categoria'"></app-title>
          <button type="button" class="btn-back" (click)="toggleCreateNew(); $event.stopPropagation()" title="Voltar">
            <mat-icon>arrow_back</mat-icon>
          </button>
        </div>

        <form [formGroup]="categoryForm" (ngSubmit)="createNewCategory()">
          <div class="form-group">
            <label for="title">Nome da Categoria *</label>
            <input
              id="title"
              type="text"
              formControlName="title"
              placeholder="Ex: Alimentação"
              class="input-field"
            />
            <small class="error" *ngIf="categoryForm.get('title')?.invalid && categoryForm.get('title')?.touched">
              O nome deve ter no mínimo 3 caracteres e no máximo 50 caracteres.
            </small>
          </div>

          <div class="form-group">
            <label>Cor da Categoria *</label>
            <div class="color-palette">
              <button
                *ngFor="let colorName of categoryColorNames"
                type="button"
                class="color-button"
                [ngStyle]="{ 'background-color': categoryColorsMap[colorName] }"
                [class.selected]="categoryForm.get('color')?.value === colorName"
                (click)="categoryForm.get('color')?.setValue(colorName)"
                [title]="colorName"
              ></button>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn-cancel"
              (click)="toggleCreateNew(); $event.stopPropagation()"
              [disabled]="isLoading"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn-submit"
              [disabled]="categoryForm.invalid || isLoading"
            >
              {{ isLoading ? (editingCategory ? 'Atualizando...' : 'Criando...') : (editingCategory ? 'Atualizar Categoria' : 'Criar Categoria') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </default-modal>
</div>
